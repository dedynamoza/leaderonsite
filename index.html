<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>West Territory 4 - Leader On Site</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* iOS Inputs Fix */
        input, select, textarea {
            font-size: 16px !important; 
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        html { scroll-behavior: smooth; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "html2canvas": "https://aistudiocdn.com/html2canvas@^1.4.1",
    "jspdf": "https://aistudiocdn.com/jspdf@^3.0.3"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONSTANTS ---
        const AspectStatus = {
            UNSELECTED: 0,
            NEED_IMPROVEMENT: 1,
            NO_NEED: 2,
        };

        const BRANCH_OPTIONS = [
            'Branch Metro Hadimulyo Barat', 'Branch Bandar Lampung Tanjung Senang', 'Branch Lampung Tengah Bandar Jaya',
            'Branch Lampung Selatan Kalianda', 'Branch Bandar Lampung Rawa Laut', 'Branch Bandar Lampung Rajabasa',
            'Branch Mesuji Umbulan Tedunggeram', 'Branch Bandar Bandar Lampung Campang Raya', 'Branch Tulang Bawang Barat Banjar Agung',
            'Branch Tulang Bawang Barat Menggala', 'Branch Jambi Kenali Asam Bawah', 'Branch Jambi Kenali Besar',
            'Branch Jambi Thehok', 'Branch Bengkulu Jembatan Kecil', 'Branch Muaro Jambi Sengeti',
            'Branch Tanjung Jabung Barat Kuala Tungkal', 'Branch Tanjung Jabung Barat Merlung', 'Branch Banyuasin Pangkalan Balai',
            'Branch Banyuasin Betung', 'Branch Banyuasin Sungsang', 'Branch Bangka Sungai Liat',
            'Branch Bangka Barat Kelapa', 'Branch Bangka Barat Muntok', 'Branch Musi Banyausin Bayung Lecir',
            'Branch Musi Banyuasin Pangkalan Gresik', 'Branch Musi Banyuasin Sungai Lilin', 'Branch Ogan Komering Ilir Kayu Agung',
            'Branch Ogan Komering Ilir Tugu Mulyo', 'Branch Palembang 8 Ulu', 'Branch Palembang Kalidoni',
            'Branch Palembang Karya Jaya', 'Branch Palembang Sekip Jaya', 'Branch Palembang Sukamaju',
            'Branch Palembang Sukodadi', 'Branch Pangkal Pinang Batin Tikal'
        ];

        const VISITOR_OPTIONS = [
            'Dedi Riyanto', 'Made Marsha Bayu Kresna', 'Piscesco Heyziputra', 'Chandri Apriasma Putra', 
            'Tommy Setiawan', 'Muhammad Harriansyah', 'Boby Kertapati', 'Danang Miftaqur Anam', 
            'Adam Harahap', 'Faisal Anggara', 'Novianto', 'Adi Febriansyah', 'Gerry Boy',
            'Bayu Prakoso', 'Nuke Utami', 'Muhammad Okyaki', 'Nurul Hakim', 'Bima Saputro', 
            'Yoga', 'Muhammad Bangga Pribadi', 'Muhammad Tasil'
        ];

        const SUBDISTRICT_OPTIONS = [
            'Kelurahan Tukak Sadai', 'Kelurahan Toboali', 'Kelurahan Tempilang', 'Kelurahan Tanjung Pandan', 
            'Kelurahan Taman Sari', 'Kelurahan Sungai Selan', 'Kelurahan Sungai Liat', 'Kelurahan Simpang Teritip', 
            'Kelurahan Simpang Rimba', 'Kelurahan Simpang Renggiang', 'Kelurahan Simpang Pesak', 'Kelurahan Simpang Katis', 
            'Kelurahan Sijuk', 'Kelurahan Selat Nasik', 'Kelurahan Riau Silip', 'Kelurahan Rangkui', 'Kelurahan Pulau Besar', 
            'Kelurahan Puding Besar', 'Kelurahan Pemali', 'Kelurahan Payung', 'Kelurahan Parittiga', 'Kelurahan Pangkalan Baru', 'Kelurahan Pangkal Balam', 'Kelurahan Namang', 
            'Kelurahan Merawang', 'Kelurahan Mentok (Muntok)', 'Kelurahan Mendo Barat', 'Kelurahan Membalong', 'Kelurahan Manggar', 'Kelurahan Lubuk Besar', 'Kelurahan Lepar Pongok', 
            'Kelurahan Koba', 'Kelurahan Kepulauan Pongok', 'Kelurahan Kelapa Kampit', 'Kelurahan Kelapa', 'Kelurahan Jebus', 'Kelurahan Girimaya', 'Kelurahan Gerunggang', 'Kelurahan Gantung', 
            'Kelurahan Gabek', 'Kelurahan Dendang', 'Kelurahan Damar', 'Kelurahan Bukit Intan', 'Kelurahan Belinyu', 'Kelurahan Bakam', 'Kelurahan Badau', 'Kelurahan Air Gegas', 'Kelurahan Talo', 
            'Kelurahan Talang Empat', 'Kelurahan Taba Penanjung', 'Kelurahan Sungai Serut', 'Kelurahan Sungai Rumbai', 'Kelurahan Sukaraja', 'Kelurahan Singaran Pati', 'Kelurahan Sindang Kelingi', 'Kelurahan Sindang Daratan', 
            'Kelurahan Sindang Beliti Ulu', 'Kelurahan Sindang Beliti Ilir', 'Kelurahan Semidang Gumai (Gumay)', 'Kelurahan Semidang Alas Maras', 'Kelurahan Semidang Alas', 'Kelurahan Selupu Rejang',
             'Kelurahan Seluma Utara', 'Kelurahan Seluma Timur', 'Kelurahan Seluma Selatan', 'Kelurahan Seluma Barat', 'Kelurahan Seluma', 'Kelurahan Selebar', 'Kelurahan Selagan Raya', 'Kelurahan Seginim',
              'Kelurahan Seberang Musi', 'Kelurahan Rimbo Pengadang', 'Kelurahan Ratu Samban', 'Kelurahan Ratu Agung', 'Kelurahan Putri Hijau', 'Kelurahan Pondok Suguh', 'Kelurahan Pondok Kubang', 'Kelurahan Pondok Kelapa',
               'Kelurahan Pinoraya', 'Kelurahan Pino', 'Kelurahan Pinang Belapis', 'Kelurahan Penarik', 'Kelurahan Pematang Tiga', 'Kelurahan Pelabai', 'Kelurahan Pasar Manna', 
               'Kelurahan Pagar Jati', 'Kelurahan Padang Ulak Tanding', 'Kelurahan Padang Jaya', 'Kelurahan Padang Guci Hulu', 'Kelurahan Padang Guci Hilir',
                'Kelurahan Nasal', 'Kelurahan Napal Putih', 'Kelurahan Muara Sahung', 'Kelurahan Muara Kemumu', 'Kelurahan Muara Bangka Hulu', 'Kelurahan Merigi Sakti', 
                'Kelurahan Merigi Kelindang', 'Kelurahan Merigi', 'Kelurahan Manna', 'Kelurahan Malin Deman', 'Kelurahan Maje', 'Kelurahan Lungkang Kule', 'Kelurahan Lubuk Sandi', 'Kelurahan Lubuk Pinang', 
                'Kelurahan Luas', 'Kelurahan Lebong Utara', 'Kelurahan Lebong Tengah', 'Kelurahan Lebong Selatan', 'Kelurahan Lebong Sakti', 'Kelurahan Lebong Atas',
                 'Kelurahan Lais', 'Kelurahan Kota Padang', 'Kelurahan Kota Mukomuko (Mukomuko Utara)', 'Kelurahan Kota Manna', 'Kelurahan Kinal', 'Kelurahan Ketahun', 'Kelurahan Kerkap',
                  'Kelurahan Kepahiang', 'Kelurahan Kelam Tengah', 'Kelurahan Kedurang Ilir', 'Kelurahan Kedurang', 'Kelurahan Kebawetan', 
                  'Kelurahan Kaur Utara', 'Kelurahan Kaur Tengah', 'Kelurahan Kaur Selatan', 'Kelurahan Karang Tinggi', 'Kelurahan Kampung Melayu', 
                  'Kelurahan Ipuh (Muko-Muko Selatan)', 'Kelurahan Ilir Talo', 'Kelurahan Hulu Palik', 'Kelurahan Giri Mulia', 'Kelurahan Gading Cempaka', 'Kelurahan Enggano',
                   'Kelurahan Curup Utara', 'Kelurahan Curup Timur', 'Kelurahan Curup Tengah', 'Kelurahan Curup Selatan', 'Kelurahan Curup', 'Kelurahan Bunga Mas', 'Kelurahan Bingin Kuning',
                    'Kelurahan Binduriang', 'Kelurahan Bermani Ulu Raya', 'Kelurahan Bermani Ulu', 'Kelurahan Bermani Ilir', 'Kelurahan Batik Nau', 'Kelurahan Bang Haji', 'Kelurahan Arma Jaya',
                     'Kelurahan Arga Makmur', 'Kelurahan Amen', 'Kelurahan Air Rami', 'Kelurahan Air Periukan', 'Kelurahan Air Padang', 'Kelurahan Air Nipis', 'Kelurahan Air Napal', 'Kelurahan Air Majunto', 
                     'Kelurahan Air Dikit', 'Kelurahan Air Besi', 'Kelurahan VII Koto Ilir', 'Kelurahan VII Koto', 'Kelurahan Tungkal Ulu', 'Kelurahan Tungkal Ilir', 'Kelurahan Tiang Pumpung',
                      'Kelurahan Tengah Ilir', 'Kelurahan Telanaipura', 'Kelurahan Tebo Ulu', 'Kelurahan Tebo Tengah', 'Kelurahan Tebo Ilir', 'Kelurahan Tebing Tinggi', 
                      'Kelurahan Tanah Tumbuh', 'Kelurahan Tanah Sepenggal Lintas', 'Kelurahan Tanah Sepenggal', 'Kelurahan Tanah Kampung', 'Kelurahan Taman Rajo', 
                      'Kelurahan Tabir Ulu', 'Kelurahan Tabir Timur', 'Kelurahan Tabir Selatan', 'Kelurahan Tabir Lintas', 'Kelurahan Tabir Ilir', 'Kelurahan Tabir Barat',
                       'Kelurahan Tabir', 'Kelurahan Sungai Tenang', 'Kelurahan Sungai Penuh', 'Kelurahan Sungai Manau', 'Kelurahan Sungai Gelam', 'Kelurahan Sungai Bungkal', 
                       'Kelurahan Sungai Bahar', 'Kelurahan Sumay', 'Kelurahan Siulak Mukai', 'Kelurahan Siulak', 'Kelurahan Sitinjau Laut', 'Kelurahan Singkut', 'Kelurahan Serai Serumpun', 'Kelurahan Senyerang', 'Kelurahan Sekernan', 'Kelurahan Seberang Kota', 'Kelurahan Sarolangun', 'Kelurahan Sadu', 'Kelurahan Rimbo Ulu', 'Kelurahan Rimbo Tengah', 'Kelurahan Rimbo Ilir', 'Kelurahan Rimbo Bujang',
                        'Kelurahan Renah Pemenang', 'Kelurahan Renah Pembarap', 'Kelurahan Renah Mendaluh', 'Kelurahan Rantau Rasau', 'Kelurahan Rantau Pandan', 'Kelurahan Pondok Tinggi', 'Kelurahan Pesisir Bukit', 'Kelurahan Pengabuan', 'Kelurahan Pemayung', 'Kelurahan Pelepat Ilir', 'Kelurahan Pelepat', 'Kelurahan Pelayangan', 'Kelurahan Pelawan', 'Kelurahan Pauh', 'Kelurahan Pasar Muara Bungo', 'Kelurahan Pasar Jambi', 'Kelurahan Pangkalan Jambu', 'Kelurahan Pamenang Selatan', 'Kelurahan Pamenang Barat', 'Kelurahan Pamenang', 'Kelurahan Nipah Panjang', 'Kelurahan Nalo Tantan', 'Kelurahan Muko-Muko Batin VII', 'Kelurahan Muara Tembesi', 'Kelurahan Muara Tabir', 'Kelurahan Muara Siau', 'Kelurahan Muara Sabak Timur', 'Kelurahan Muara Sabak Barat', 'Kelurahan Muara Papalik', 'Kelurahan Muara Bulian', 'Kelurahan Mestong', 'Kelurahan Mersam', 'Kelurahan Merlung', 'Kelurahan Mendahara Ulu', 'Kelurahan Mendahara', 'Kelurahan Maro Sebo Ulu', 'Kelurahan Maro Sebo Ilir', 'Kelurahan Maro Sebo', 'Kelurahan Margo Tabir', 'Kelurahan Mandiangin', 'Kelurahan Limun', 'Kelurahan Limbur Lubuk Mengkuang', 'Kelurahan Lembah Masurai', 'Kelurahan Kumun Debai', 'Kelurahan Kumpeh Ulu', 'Kelurahan Kumpeh', 'Kelurahan Kuala Jambi', 'Kelurahan Kuala Betara', 'Kelurahan Koto Baru', 'Kelurahan Kota Baru', 'Kelurahan Keliling Danau', 'Kelurahan Kayu Aro Barat', 'Kelurahan Kayu Aro', 'Kelurahan Jujuhan Ilir', 'Kelurahan Jujuhan', 'Kelurahan Jelutung', 'Kelurahan Jangkat', 'Kelurahan Jambi Timur', 'Kelurahan Jambi Selatan', 'Kelurahan Jambi Luar Kota', 'Kelurahan Hamparan Rawang', 'Kelurahan Gunung Tujuh', 'Kelurahan Gunung Raya', 'Kelurahan Gunung Kerinci', 'Kelurahan Geragai', 'Kelurahan Depati Tujuh', 'Kelurahan Dendang', 'Kelurahan Danau Teluk', 'Kelurahan Danau Kerinci', 'Kelurahan Cermin Nan Gadang', 'Kelurahan Bungo Dani', 'Kelurahan Bukitkerman', 'Kelurahan Bram Itam', 'Kelurahan Betara', 'Kelurahan Berbak', 'Kelurahan Batin XXIV', 'Kelurahan Bathin VIII (Batin VIII)', 'Kelurahan Bathin III Ulu', 'Kelurahan Bathin III', 'Kelurahan Bathin II Pelayang', 'Kelurahan Bathin II Babeko', 'Kelurahan Batang Merangin', 'Kelurahan Batang Masumai', 'Kelurahan Batang Asam', 'Kelurahan Batang Asai', 'Kelurahan Bangko Barat', 'Kelurahan Bangko', 'Kelurahan Bajubang', 'Kelurahan Bahar Utara', 'Kelurahan Bahar Selatan', 'Kelurahan Air Hitam', 'Kelurahan Air Hangat Timur', 'Kelurahan Air Hangat Barat', 'Kelurahan Air Hangat', 'Kelurahan Bumi Waras', 'Kelurahan Enggal', 'Kelurahan Kedamaian', 'Kelurahan Kedaton', 'Kelurahan Kemiling', 'Kelurahan Labuhan Ratu', 'Kelurahan Langkapura', 'Kelurahan Panjang', 'Kelurahan Rajabasa', 'Kelurahan Sukabumi', 'Kelurahan Sukarame', 'Kelurahan Tanjung Karang Barat', 'Kelurahan Tanjung Karang Pusat', 'Kelurahan Tanjung Karang Timur', 'Kelurahan Tanjung Senang', 'Kelurahan Telukbetung Barat', 'Kelurahan Telukbetung Selatan', 'Kelurahan Telukbetung Timur', 'Kelurahan Telukbetung Utara', 'Kelurahan Way Halim', 'Kelurahan Air Hitam', 'Kelurahan Balik Bukit', 'Kelurahan Bandar Negeri Suoh', 'Kelurahan Batu Brak', 'Kelurahan Batu Ketulis', 'Kelurahan Belalau', 'Kelurahan Gedung Surian', 'Kelurahan Kebun Tebu', 'Kelurahan Lumbok Seminung', 'Kelurahan Pagar Dewa', 'Kelurahan Sekincau', 'Kelurahan Sukau', 'Kelurahan Sumber Jaya', 'Kelurahan Suoh', 'Kelurahan Way Tenong', 'Kelurahan Bakauheni', 'Kelurahan Candipuro', 'Kelurahan Jati Agung', 'Kelurahan Kalianda', 'Kelurahan Katibung', 'Kelurahan Ketapang', 'Kelurahan Merbau Mataram', 'Kelurahan Natar', 'Kelurahan Palas', 'Kelurahan Penengahan', 'Kelurahan Rajabasa', 'Kelurahan Sidomulyo', 'Kelurahan Sragi', 'Kelurahan Tanjung Bintang', 'Kelurahan Tanjung Sari', 'Kelurahan Way Panji', 'Kelurahan Way Sulan', 'Kelurahan Anak Ratu Aji', 'Kelurahan Anak Tuha', 'Kelurahan Bandar Mataram', 'Kelurahan Bandar Surabaya', 'Kelurahan Bangun Rejo', 'Kelurahan Bekri', 'Kelurahan Bumi Nabung', 'Kelurahan Bumi Ratu Nuban', 'Kelurahan Gunung Sugih', 'Kelurahan Kalirejo', 'Kelurahan Kota Gajah', 'Kelurahan Padang Ratu', 'Kelurahan Pubian', 'Kelurahan Punggur', 'Kelurahan Putra Rumbia', 'Kelurahan Rumbia', 'Kelurahan Selagai Lingga', 'Kelurahan Sendang Agung', 'Kelurahan Seputih Agung', 'Kelurahan Seputih Banyak', 'Kelurahan Seputih Mataram', 'Kelurahan Seputih Raman', 'Kelurahan Seputih Surabaya', 'Kelurahan Terbanggi Besar', 'Kelurahan Terusan Nunyai', 'Kelurahan Trimurjo', 'Kelurahan Way Pangubuan', 'Kelurahan Way Seputih', 'Kelurahan Bandar Sribawono', 'Kelurahan Batanghari', 'Kelurahan Batanghari Nuban', 'Kelurahan Braja Slebah', 'Kelurahan Bumi Agung', 'Kelurahan Gunung Pelindung', 'Kelurahan Jabung', 'Kelurahan Labuhan Maringgai', 'Kelurahan Labuhan Ratu', 'Kelurahan Marga Sekampung', 'Kelurahan Margatiga', 'Kelurahan Mataram Baru', 'Kelurahan Melinting', 'Kelurahan Metro Kibang', 'Kelurahan Pasir Sakti', 'Kelurahan Pekalongan', 'Kelurahan Purbolinggo', 'Kelurahan Raman Utara', 'Kelurahan Sekampung', 'Kelurahan Sekampung Udik', 'Kelurahan Sukadana', 'Kelurahan Waway Karya', 'Kelurahan Way Bungur (Purbolinggo Utara)', 'Kelurahan Way Jepara', 'Kelurahan Abung Barat', 'Kelurahan Abung Kunang', 'Kelurahan Abung Pekurun', 'Kelurahan Abung Selatan', 'Kelurahan Abung Semuli', 'Kelurahan Abung Surakarta', 'Kelurahan Abung Tengah', 'Kelurahan Abung Timur', 'Kelurahan Abung Tinggi', 'Kelurahan Blambangan Pagar', 'Kelurahan Bukit Kemuning', 'Kelurahan Bunga Mayang', 'Kelurahan Hulu Sungkai', 'Kelurahan Kotabumi', 'Kelurahan Kotabumi Selatan', 'Kelurahan Kotabumi Utara', 'Kelurahan Muara Sungkai', 'Kelurahan Sungkai Barat', 'Kelurahan Sungkai Jaya', 'Kelurahan Sungkai Selatan', 'Kelurahan Sungkai Tengah', 'Kelurahan Sungkai Utara', 'Kelurahan Tanjung Raja', 'Kelurahan Mesuji', 'Kelurahan Mesuji Timur', 'Kelurahan Panca Jaya', 'Kelurahan Rawa Jitu Utara', 'Kelurahan Simpang Pematang', 'Kelurahan Tanjung Raya', 'Kelurahan Way Serdang', 'Kelurahan Metro Barat', 'Kelurahan Metro Pusat', 'Kelurahan Metro Selatan', 'Kelurahan Metro Timur', 'Kelurahan Metro Utara', 'Kelurahan Gedong Tataan', 'Kelurahan Kedondong', 'Kelurahan Marga Punduh', 'Kelurahan Negeri Katon', 'Kelurahan Padang Cermin', 'Kelurahan Punduh Pidada', 'Kelurahan Tegineneng', 'Kelurahan Way Khilau', 'Kelurahan Way Lima', 'Kelurahan Bengkunat', 'Kelurahan Bengkunat Belimbing', 'Kelurahan Karya Penggawa', 'Kelurahan Krui Selatan', 'Kelurahan Lemong', 'Kelurahan Ngambur', 'Kelurahan Pesisir Selatan', 'Kelurahan Pesisir Tengah', 'Kelurahan Pesisir Utara', 'Kelurahan Pulau Pisang', 'Kelurahan Way Krui', 'Kelurahan Adi Luwih', 'Kelurahan Ambarawa', 'Kelurahan Banyumas', 'Kelurahan Gading Rejo', 'Kelurahan Pagelaran', 'Kelurahan Pagelaran Utara', 'Kelurahan Pardasuka', 'Kelurahan Pringsewu', 'Kelurahan Sukoharjo', 'Kelurahan Air Naningan', 'Kelurahan Bandar Negeri Semuong', 'Kelurahan Bulok', 'Kelurahan Cukuh Balak', 'Kelurahan Gisting', 'Kelurahan Gunung Alip', 'Kelurahan Kelumbayan', 'Kelurahan Kelumbayan Barat', 'Kelurahan Kota Agung (Kota Agung Pusat)', 'Kelurahan Kota Agung Barat', 'Kelurahan Kota Agung Timur', 'Kelurahan Limau', 'Kelurahan Pematang Sawa', 'Kelurahan Pugung', 'Kelurahan Pulau Panggung', 'Kelurahan Semaka', 'Kelurahan Sumberejo', 'Kelurahan Talang Padang', 'Kelurahan Ulubelu', 'Kelurahan Wonosobo', 'Kelurahan Banjar Agung', 'Kelurahan Banjar Baru', 'Kelurahan Banjar Margo', 'Kelurahan Dente Teladas', 'Kelurahan Gedung Aji', 'Kelurahan Gedung Aji Baru', 'Kelurahan Gedung Meneng', 'Kelurahan Menggala', 'Kelurahan Menggala Timur', 'Kelurahan Meraksa Aji', 'Kelurahan Penawar Aji', 'Kelurahan Penawar Tama', 'Kelurahan Rawa Pitu', 'Kelurahan Rawajitu Selatan', 'Kelurahan Rawajitu Timur', 'Kelurahan Gunung Agung', 'Kelurahan Gunung Terang', 'Kelurahan Lambu Kibang', 'Kelurahan Pagar Dewa', 'Kelurahan Tulang Bawang Tengah', 'Kelurahan Tulang Bawang Udik', 'Kelurahan Tumijajar', 'Kelurahan Way Kenanga', 'Kelurahan Bahuga', 'Kelurahan Banjit', 'Kelurahan Baradatu', 'Kelurahan Blambangan Umpu', 'Kelurahan Buay Bahuga', 'Kelurahan Bumi Agung', 'Kelurahan Gunung Labuhan', 'Kelurahan Kasui', 'Kelurahan Negara Batin', 'Kelurahan Negeri Agung', 'Kelurahan Negeri Besar', 'Kelurahan Pakuan Ratu', 'Kelurahan Rebang Tangkas', 'Kelurahan Way Tuba', 'Kelurahan Air Kumbang', 'Kelurahan Air Salek', 'Kelurahan Banyuasin I', 'Kelurahan Banyuasin II', 'Kelurahan Banyuasin III', 'Kelurahan Betung', 'Kelurahan Makarti Jaya', 'Kelurahan Muara Padang', 'Kelurahan Muara Sugihan', 'Kelurahan Muara Telang', 'Kelurahan Pulau Rimau', 'Kelurahan Rambutan', 'Kelurahan Rantau Bayur', 'Kelurahan Sembawa', 'Kelurahan Suak Tapeh', 'Kelurahan Sumber Marga Telang', 'Kelurahan Talang Kelapa', 'Kelurahan Tanjung Lago', 'Kelurahan Tungkal Ilir', 'Kelurahan Lintang Kanan', 'Kelurahan Muara Pinang', 'Kelurahan Pasemah Air Keruh', 'Kelurahan Pendopo', 'Kelurahan Pendopo Barat', 'Kelurahan Saling', 'Kelurahan Sikap Dalam', 'Kelurahan Talang Padang', 'Kelurahan Tebing Tinggi', 'Kelurahan Ulu Musi', 'Kelurahan Gumay Talang', 'Kelurahan Gumay Ulu', 'Kelurahan Jarai', 'Kelurahan Kikim Barat', 'Kelurahan Kikim Selatan', 'Kelurahan Kikim Tengah', 'Kelurahan Kikim Timur', 'Kelurahan Kota Agung', 'Kelurahan Lahat', 'Kelurahan Merapi Barat', 'Kelurahan Merapi Selatan', 'Kelurahan Merapi Timur', 'Kelurahan Muarapayang', 'Kelurahan Mulak Ulu', 'Kelurahan Pagar Gunung', 'Kelurahan Pajar Bulan', 'Kelurahan Pseksu', 'Kelurahan Pulau Pinang', 'Kelurahan Sukamerindu', 'Kelurahan Tanjung Sakti Pumi', 'Kelurahan Tanjung Sakti Pumu', 'Kelurahan Tanjung Tebat', 'Kelurahan Lubuk Linggau Barat Dua (II)', 'Kelurahan Lubuk Linggau Barat Satu (I)', 'Kelurahan Lubuk Linggau Selatan Dua (II)', 'Kelurahan Lubuk Linggau Selatan Satu (I)', 'Kelurahan Lubuk Linggau Timur Dua (II)', 'Kelurahan Lubuk Linggau Timur Satu (I)', 'Kelurahan Lubuk Linggau Utara Dua (II)', 'Kelurahan Lubuk Linggau Utara Satu (I)', 'Kelurahan Belida Darat', 'Kelurahan Belimbing', 'Kelurahan Benakat', 'Kelurahan Gelumbang', 'Kelurahan Gunung Megang', 'Kelurahan Kelekar', 'Kelurahan Lawang Kidul', 'Kelurahan Lembak', 'Kelurahan Lubai', 'Kelurahan Lubai Ulu', 'Kelurahan Muara Belida', 'Kelurahan Muara Enim', 'Kelurahan Rambang', 'Kelurahan Rambang Dangku', 'Kelurahan Semende Darat Laut', 'Kelurahan Semende Darat Tengah', 'Kelurahan Semende Darat Ulu', 'Kelurahan Sungai Rotan', 'Kelurahan Tanjung Agung', 'Kelurahan Ujan Mas', 'Kelurahan Babat Supat', 'Kelurahan Babat Toman', 'Kelurahan Batanghari Leko', 'Kelurahan Bayung Lencir', 'Kelurahan Keluang', 'Kelurahan Lais', 'Kelurahan Lalan (Sungai Lalan)', 'Kelurahan Lawang Wetan', 'Kelurahan Plakat Tinggi (Pelakat Tinggi)', 'Kelurahan Sanga Desa', 'Kelurahan Sekayu', 'Kelurahan Sungai Keruh', 'Kelurahan Sungai Lilin', 'Kelurahan Tungkal Jaya', 'Kelurahan BTS Ulu', 'Kelurahan Jaya Loka', 'Kelurahan Megang Sakti', 'Kelurahan Muara Beliti', 'Kelurahan Muara Kelingi', 'Kelurahan Muara Lakitan', 'Kelurahan Purwodadi', 'Kelurahan Selangit', 'Kelurahan Sukakarya', 'Kelurahan Suku Tengah Lakitan Ulu Terawas', 'Kelurahan Sumber Harta', 'Kelurahan Tiang Pumpung Kepungut', 'Kelurahan Tuah Negeri', 'Kelurahan Tugumulyo', 'Kelurahan Karang Dapo', 'Kelurahan Karang Jaya', 'Kelurahan Nibung', 'Kelurahan Rawas Ilir', 'Kelurahan Rawas Ulu', 'Kelurahan Rupit', 'Kelurahan Ulu Rawas', 'Kelurahan Indralaya', 'Kelurahan Indralaya Selatan', 'Kelurahan Indralaya Utara', 'Kelurahan Kandis', 'Kelurahan Lubuk Keliat', 'Kelurahan Muara Kuang', 'Kelurahan Payaraman', 'Kelurahan Pemulutan', 'Kelurahan Pemulutan Barat', 'Kelurahan Pemulutan Selatan', 'Kelurahan Rambang Kuang', 'Kelurahan Rantau Alai', 'Kelurahan Rantau Panjang', 'Kelurahan Sungai Pinang', 'Kelurahan Tanjung Batu', 'Kelurahan Tanjung Raja', 'Kelurahan Air Sugihan', 'Kelurahan Cengal', 'Kelurahan Jejawi', 'Kelurahan Kayu Agung', 'Kelurahan Lempuing', 'Kelurahan Lempuing Jaya', 'Kelurahan Mesuji', 'Kelurahan Mesuji Makmur', 'Kelurahan Mesuji Raya', 'Kelurahan Pampangan', 'Kelurahan Pangkalan Lampam', 'Kelurahan Pedamaran', 'Kelurahan Pedamaran Timur', 'Kelurahan Sirah Pulau Padang', 'Kelurahan Sungai Menang', 'Kelurahan Tanjung Lubuk', 'Kelurahan Teluk Gelam', 'Kelurahan Tulung Selapan', 'Kelurahan Baturaja Barat', 'Kelurahan Baturaja Timur', 'Kelurahan Lengkiti', 'Kelurahan Lubuk Batang', 'Kelurahan Lubuk Raja', 'Kelurahan Muara Jaya', 'Kelurahan Pengandonan', 'Kelurahan Peninjauan', 'Kelurahan Semidang Aji', 'Kelurahan Sinar Peninjauan', 'Kelurahan Sosoh Buay Rayap', 'Kelurahan Ulu Ogan', 'Kelurahan Banding Agung', 'Kelurahan Buana Pemaca', 'Kelurahan Buay Pemaca', 'Kelurahan Buay Pematang Ribu Ranau Tengah', 'Kelurahan Buay Rawan', 'Kelurahan Buay Runjung', 'Kelurahan Buay Sandang Aji', 'Kelurahan Kisam Ilir', 'Kelurahan Kisam Tinggi', 'Kelurahan Mekakau Ilir', 'Kelurahan Muaradua', 'Kelurahan Muaradua Kisam', 'Kelurahan Pulau Beringin', 'Kelurahan Runjung Agung', 'Kelurahan Simpang', 'Kelurahan Sindang Danau', 'Kelurahan Sungai Are', 'Kelurahan Tiga Dihaji', 'Kelurahan Warkuk Ranau Selatan', 'Kelurahan Belitang', 'Kelurahan Belitang II', 'Kelurahan Belitang III', 'Kelurahan Belitang Jaya', 'Kelurahan Belitang Madang Raya', 'Kelurahan Belitang Mulya', 'Kelurahan Buay Madang', 'Kelurahan Buay Madang Timur', 'Kelurahan Buay Pemuka Bangsa Raja', 'Kelurahan Buay Pemuka Peliung', 'Kelurahan Bunga Mayang', 'Kelurahan Cempaka', 'Kelurahan Jayapura', 'Kelurahan Madang Suku I', 'Kelurahan Madang Suku II', 'Kelurahan Madang Suku III', 'Kelurahan Martapura', 'Kelurahan Semendawai Barat', 'Kelurahan Semendawai Suku III', 'Kelurahan Semendawai Timur', 'Kelurahan Dempo Selatan', 'Kelurahan Dempo Tengah', 'Kelurahan Dempo Utara', 'Kelurahan Pagar Alam Selatan', 'Kelurahan Pagar Alam Utara', 'Kelurahan Alang-Alang Lebar', 'Kelurahan Bukit Kecil', 'Kelurahan Gandus', 'Kelurahan Ilir Barat I', 'Kelurahan Ilir Barat II', 'Kelurahan Ilir Timur I', 'Kelurahan Ilir Timur II', 'Kelurahan Kalidoni', 'Kelurahan Kemuning', 'Kelurahan Kertapati', 'Kelurahan Plaju', 'Kelurahan Sako', 'Kelurahan Seberang Ulu I', 'Kelurahan Seberang Ulu II', 'Kelurahan Sematang Borang', 'Kelurahan Sukarami', 'Kelurahan Abab', 'Kelurahan Penukal', 'Kelurahan Penukal Utara', 'Kelurahan Talang Ubi', 'Kelurahan Tanah Abang', 'Kelurahan Cambai', 'Kelurahan Prabumulih Barat', 'Kelurahan Prabumulih Selatan', 'Kelurahan Prabumulih Timur', 'Kelurahan Prabumulih Utara', 'Kelurahan Rambang Kapak Tengahh',
        ];

        const INITIAL_ASPECTS = [
            { id: 'branchCondition', title: 'Branch Condition', status: AspectStatus.UNSELECTED, description: '', placeholder: 'e.g., Wallpaper Kusam, AC MAti, Vinyl Kotor...' },
            { id: 'sop', title: 'S.O.P Adherence', status: AspectStatus.UNSELECTED, description: '', placeholder: 'e.g., Team Telat, Seragam tidak sesuai, tidak greeting...' },
            { id: 'salesKnowledge', title: 'Biznet Knowledge', status: AspectStatus.UNSELECTED, description: '', placeholder: 'e.g., Team tidak tahu promo terbaru, tidak tahu product...' },
            { id: 'atl', title: 'Branding / ATL', status: AspectStatus.UNSELECTED, description: '', placeholder: 'e.g., Baliho rusak, sapanduk rusak, tidak ada branding...' },
        ];

        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZhZguj-635fHhMt-HX86JEvhoksbHX1sb5IOqpvS9ohGKnsBQVfqRKNhElhAXWpUa/exec";

        // --- UTILS ---
        function generateSummary(ratings) {
            const { speed, stability, support, price, overall } = ratings;
            const values = Object.values(ratings);
            
            if (values.every(r => r === 0)) {
                return "Please provide ratings to generate an automatic summary.";
            }

            let text = [];
            const avg = values.reduce((a, b) => a + b, 0) / values.length;

            // Speed
            if (speed <= 2) text.push(`<span class="text-red-600 font-bold">Pelanggan merasa kecepatan internet sangat lambat.</span>`);
            else if (speed === 3) text.push(`Kecepatan internet dirasa cukup baik, namun kadang melambat.`);
            else text.push(`Kecepatan internet dinilai cepat dan memuaskan.`);

            // Stability
            if (stability <= 2) text.push(`<span class="text-red-600 font-bold">Koneksi sering tidak stabil/RTO.</span>`);
            else if (stability === 3) text.push(`Koneksi cukup stabil, gangguan minor.`);
            else text.push(`Koneksi internet sangat stabil.`);

            // Support -> Changed to "After Sales"
            if (support <= 2) text.push(`<span class="text-red-600 font-bold">Layanan After Sales lambat respon.</span>`);
            else if (support === 3) text.push(`Layanan After Sales cukup responsif.`);
            else text.push(`Layanan After Sales sangat membantu dan ramah.`);

            // Price
            if (price <= 2) text.push(`<span class="text-red-600 font-bold">Harga terlalu mahal vs kualitas.</span>`);
            else if (price === 3) text.push(`Harga standard.`);
            else text.push(`Harga sangat worth it.`);

            // Conclusion
            let conclusion = "";
            if (avg <= 2.5) conclusion = `<span class="text-red-600 font-bold block mt-2">KESIMPULAN: Kepuasan rendah. Perlu tindak lanjut segera.</span>`;
            else if (avg < 4) conclusion = `<span class="text-gray-700 block mt-2">KESIMPULAN: Cukup puas, perlu maintenance rutin.</span>`;
            else conclusion = `<span class="text-green-600 font-bold block mt-2">KESIMPULAN: Sangat Puas (Promoter).</span>`;

            return text.join(" ") + " " + conclusion;
        }

        const generateUUID = () => {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };

        // --- SERVICES ---
        const sendDataToSheet = async (data) => {
            try {
                const payload = {
                    date: data.date,
                    visitor: data.visitorName,
                    branch: data.branchName,
                    includeInternal: data.includeInternal,
                    aspects: data.includeInternal ? data.aspects : [],
                    experiences: data.experiences.map(exp => ({
                        billingAccount: exp.billingAccount,
                        subDistrict: exp.subDistrict,
                        name: exp.name,
                        ratings: exp.ratings,
                        summary: exp.summary.replace(/<[^>]*>?/gm, ''), // Clean HTML tags
                    }))
                };

                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                console.log("Data sent to background script.");
                return true;
            } catch (error) {
                console.error("Error sending data to sheet:", error);
                return false;
            }
        };

        const generateAndSendReport = async (data) => {
            try {
                await sendDataToSheet(data);

                const element = document.getElementById('report-preview-container');
                if (!element) throw new Error("Report template not found");

                // OPTIMIZATION: Use 1.5 scale and JPEG to reduce file size < 5MB
                const canvas = await html2canvas(element, { 
                    scale: 1.5, 
                    useCORS: true, 
                    backgroundColor: '#ffffff', 
                    logging: false 
                });

                // 0.6 Quality JPEG
                const imgData = canvas.toDataURL('image/jpeg', 0.6);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });

                pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height);
                
                const filename = `Visit_${data.branchName.replace(/\s+/g, '_')}_${data.date}.pdf`;
                pdf.save(filename);

                const subject = `Visitation Report: ${data.branchName} - ${data.date}`;
                const body = `Dear Team,\n\nAttached is the visitation report for ${data.branchName} conducted on ${data.date} by ${data.visitorName}.\n\nSummary:\n${data.experiences.length} Customer(s) visited.\n\nRegards.`;
                window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                return true;
            } catch (error) {
                console.error("PDF Generation Error:", error);
                alert("Failed to generate report. Please ensure all images are loaded properly.");
                return false;
            }
        };

        // --- UI COMPONENTS ---
        const Button = ({ children, variant = 'primary', isLoading, icon, className = '', disabled, ...props }) => {
            const base = "inline-flex items-center justify-center px-4 py-2.5 rounded-lg font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95";
            const variants = {
                primary: "bg-brand-600 hover:bg-brand-700 text-white focus:ring-brand-500 shadow-md hover:shadow-lg",
                secondary: "bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 focus:ring-gray-200 shadow-sm",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 focus:ring-red-500 border border-red-200",
                ghost: "text-gray-500 hover:text-brand-600 hover:bg-brand-50"
            };
            return (
                <button className={`${base} ${variants[variant]} ${className}`} disabled={disabled || isLoading} {...props}>
                    {isLoading && <svg className="animate-spin -ml-1 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>}
                    {!isLoading && icon && <span className="mr-2">{icon}</span>}
                    {children}
                </button>
            );
        };

        // FIX: Removed overflow-hidden to allow dropdowns to overflow
        // Added rounded-t-xl to header to keep UI clean
        const Card = ({ children, className = '', title, action, onClick }) => (
            <div className={`bg-white rounded-xl border border-gray-200 shadow-sm ${className}`} onClick={onClick}>
                {(title || action) && (
                    <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-xl">
                        {title && <h3 className="text-lg font-semibold text-gray-800">{title}</h3>}
                        {action && <div>{action}</div>}
                    </div>
                )}
                <div className="p-6">{children}</div>
            </div>
        );

        const SearchableSelect = ({ options, value, onChange, placeholder, label }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const wrapperRef = useRef(null);
            const filtered = options.filter(opt => opt.toLowerCase().includes(searchTerm.toLowerCase()));

            useEffect(() => {
                const handleClickOutside = (e) => { if (wrapperRef.current && !wrapperRef.current.contains(e.target)) setIsOpen(false); };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const handleSelect = (opt) => { onChange(opt); setSearchTerm(''); setIsOpen(false); };

            return (
                <div className="relative" ref={wrapperRef}>
                    {label && <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
                    <div className="relative" onClick={() => setIsOpen(true)}>
                        <input type="text" readOnly={!isOpen} className={`w-full pl-4 pr-10 py-2.5 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none transition-colors ${!value && !isOpen ? 'text-gray-400' : 'text-gray-900'}`} placeholder={placeholder} value={isOpen ? searchTerm : value} onChange={e => { setSearchTerm(e.target.value); if(!isOpen) setIsOpen(true); }} />
                        <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" /></svg></div>
                    </div>
                    {isOpen && (
                        <div className="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl max-h-60 overflow-auto animate-fade-in">
                            {filtered.length === 0 ? <div className="px-4 py-3 text-sm text-gray-500">No results found</div> : (
                                <ul className="py-1">
                                    {filtered.map((opt, idx) => (
                                        <li key={idx} onClick={(e) => { e.stopPropagation(); handleSelect(opt); }} className={`px-4 py-2 text-sm cursor-pointer transition-colors ${value === opt ? 'bg-brand-50 text-brand-700 font-medium' : 'text-gray-700 hover:bg-gray-50'}`}>{opt}</li>
                                    ))}
                                </ul>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const CameraModal = ({ isOpen, onClose, onCapture }) => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [stream, setStream] = useState(null);
            const [error, setError] = useState('');
            const [facingMode, setFacingMode] = useState('environment');

            useEffect(() => {
                if (isOpen) startCamera();
                return () => { if (stream) stream.getTracks().forEach(track => track.stop()); };
            }, [isOpen, facingMode]);

            const startCamera = async () => {
                try {
                    if (stream) stream.getTracks().forEach(track => track.stop());
                    const newStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode } });
                    setStream(newStream);
                    if (videoRef.current) videoRef.current.srcObject = newStream;
                    setError('');
                } catch (err) { setError('Camera access denied.'); }
            };

            const handleCapture = () => {
                if (videoRef.current && canvasRef.current) {
                    const video = videoRef.current;
                    const canvas = canvasRef.current;
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    
                    const timestamp = new Date().toLocaleString();
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(0, canvas.height - 60, canvas.width, 60);
                    ctx.fillStyle = 'white';
                    ctx.font = '16px Arial';
                    ctx.fillText(timestamp, 20, canvas.height - 25);

                    try {
                        navigator.geolocation.getCurrentPosition((pos) => {
                            const loc = `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
                            ctx.fillText(loc, 20, canvas.height - 45);
                            onCapture(canvas.toDataURL('image/jpeg', 0.8), loc);
                            onClose();
                        }, () => { onCapture(canvas.toDataURL('image/jpeg', 0.8)); onClose(); }, { timeout: 3000 });
                    } catch { onCapture(canvas.toDataURL('image/jpeg', 0.8)); onClose(); }
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[60] bg-black flex flex-col items-center justify-center">
                    {error ? <div className="p-8 text-center text-white"><p className="mb-4 text-red-400">{error}</p><Button onClick={onClose} variant="secondary">Close</Button></div> : (
                        <div className="relative w-full h-full bg-black flex flex-col">
                            <div className="flex-1 relative overflow-hidden"><video ref={videoRef} autoPlay playsInline className="absolute inset-0 w-full h-full object-cover" /></div>
                            <canvas ref={canvasRef} className="hidden" />
                            <div className="flex-shrink-0 p-6 bg-black flex items-center justify-between pb-[calc(1.5rem+env(safe-area-inset-bottom))]">
                                <button onClick={onClose} className="text-white p-3 rounded-full bg-white/10 backdrop-blur"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                                <button onClick={handleCapture} className="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center bg-white/20"><div className="w-16 h-16 bg-white rounded-full"></div></button>
                                <button onClick={() => setFacingMode(p => p === 'user' ? 'environment' : 'user')} className="text-white p-3 rounded-full bg-white/10 backdrop-blur"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg></button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- SECTIONS ---
        const StepOneBasic = ({ data, updateData }) => (
            <div className="max-w-2xl mx-auto animate-slide-up">
                {/* FIX: Added z-20 to ensure dropdown overlaps the card below */}
                <Card title="Visitation Details" className="mb-6 relative z-20">
                    <div className="space-y-6">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Visit Date</label>
                            <input type="date" value={data.date} onChange={e => updateData({ date: e.target.value })} className="w-full px-4 py-2.5 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none transition-colors" />
                        </div>
                        <SearchableSelect label="Visitor Name" options={VISITOR_OPTIONS} value={data.visitorName} onChange={val => updateData({ visitorName: val })} placeholder="Search visitor..." />
                        <SearchableSelect label="Branch Name" options={BRANCH_OPTIONS} value={data.branchName} onChange={val => updateData({ branchName: val })} placeholder="Search branch..." />
                    </div>
                </Card>
                {/* FIX: Added z-10 */}
                <Card className="cursor-pointer hover:border-brand-300 transition-colors relative z-10" onClick={() => updateData({ includeInternal: !data.includeInternal })}>
                    <div className="flex items-center justify-between">
                        <div><h3 className="text-lg font-semibold text-gray-800">Sidak Branch</h3><p className="text-sm text-gray-500">Include branch condition & SOP checklist?</p></div>
                        <div className={`w-14 h-8 flex items-center rounded-full p-1 transition-colors duration-300 ${data.includeInternal ? 'bg-brand-600' : 'bg-gray-200'}`}><div className={`bg-white w-6 h-6 rounded-full shadow-md transform transition-transform duration-300 ${data.includeInternal ? 'translate-x-6' : 'translate-x-0'}`}></div></div>
                    </div>
                </Card>
            </div>
        );

        const StepTwoAspects = ({ data, updateData }) => {
            const handleAspectChange = (id, field, value) => {
                updateData({ aspects: data.aspects.map(a => a.id === id ? { ...a, [field]: value } : a) });
            };
            return (
                <div className="space-y-6 max-w-3xl mx-auto animate-slide-up">
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 flex items-start"><span className="text-2xl mr-3">üè¢</span><div><h4 className="font-semibold text-blue-900">Sidak Branch</h4><p className="text-sm text-blue-800">Please evaluate the branch condition carefully.</p></div></div>
                    {data.aspects.map(aspect => (
                        <Card key={aspect.id} className={`transition-all duration-200 ${aspect.status === AspectStatus.NEED_IMPROVEMENT ? 'border-l-4 border-l-red-500' : aspect.status === AspectStatus.NO_NEED ? 'border-l-4 border-l-green-500' : ''}`}>
                            <div className="md:flex md:justify-between md:items-start gap-6">
                                <div className="mb-4 md:mb-0 md:w-1/3">
                                    <h3 className="text-lg font-bold text-gray-800 mb-2">{aspect.title}</h3>
                                    <div className="flex flex-col space-y-2">
                                        <label className={`flex items-center p-3 rounded-lg border cursor-pointer ${aspect.status === AspectStatus.NEED_IMPROVEMENT ? 'bg-red-50 border-red-200 text-red-700' : 'bg-white border-gray-200'}`}><input type="radio" checked={aspect.status === AspectStatus.NEED_IMPROVEMENT} onChange={() => handleAspectChange(aspect.id, 'status', AspectStatus.NEED_IMPROVEMENT)} className="w-4 h-4 text-red-600 focus:ring-red-500" /><span className="ml-2">Need Improvement</span></label>
                                        <label className={`flex items-center p-3 rounded-lg border cursor-pointer ${aspect.status === AspectStatus.NO_NEED ? 'bg-green-50 border-green-200 text-green-700' : 'bg-white border-gray-200'}`}><input type="radio" checked={aspect.status === AspectStatus.NO_NEED} onChange={() => handleAspectChange(aspect.id, 'status', AspectStatus.NO_NEED)} className="w-4 h-4 text-green-600 focus:ring-green-500" /><span className="ml-2">No Need</span></label>
                                    </div>
                                </div>
                                <div className="md:w-2/3"><label className="block text-sm font-medium text-gray-700 mb-1">Observations</label><textarea value={aspect.description} onChange={e => handleAspectChange(aspect.id, 'description', e.target.value)} disabled={aspect.status !== AspectStatus.NEED_IMPROVEMENT} placeholder={aspect.status === AspectStatus.NEED_IMPROVEMENT ? aspect.placeholder : "Select 'Need Improvement' to add details."} className="w-full h-32 p-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white outline-none disabled:opacity-50 resize-none" /></div>
                            </div>
                        </Card>
                    ))}
                </div>
            );
        };

        const StepThreeExperience = ({ data, updateData }) => {
            const [cameraOpen, setCameraOpen] = useState(false);
            const [activeExpId, setActiveExpId] = useState(null);
            const [showSourceSelector, setShowSourceSelector] = useState(false);

            const updateExperience = (id, updates) => {
                const newExps = data.experiences.map(exp => {
                    if (exp.id === id) {
                        const updated = { ...exp, ...updates };
                        if (updates.ratings) updated.summary = generateSummary(updated.ratings);
                        return updated;
                    }
                    return exp;
                });
                updateData({ experiences: newExps });
            };

            const addExperience = () => updateData({ experiences: [...data.experiences, { id: generateUUID(), billingAccount: '', subDistrict: '', name: '', ratings: { speed: 0, stability: 0, support: 0, price: 0, overall: 0 }, summary: 'Please provide ratings...', images: [] }] });
            const removeExperience = (id) => updateData({ experiences: data.experiences.filter(e => e.id !== id) });

            const handleImageCapture = (src, location) => {
                if (activeExpId) {
                    const exp = data.experiences.find(e => e.id === activeExpId);
                    if (exp) updateExperience(activeExpId, { images: [...exp.images, { id: generateUUID(), src, timestamp: new Date().toLocaleTimeString(), location }] });
                }
            };

            const handleFileUpload = (e, expId) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        if (evt.target?.result) updateData({ experiences: data.experiences.map(x => x.id === expId ? { ...x, images: [...x.images, { id: generateUUID(), src: evt.target.result, timestamp: new Date().toLocaleTimeString() }] } : x) });
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            };

            return (
                <div className="space-y-8 max-w-4xl mx-auto animate-slide-up">
                    {data.experiences.map((exp, index) => (
                        <Card key={exp.id} className="border-t-4 border-t-brand-500 relative" title={`Customer #${index + 1}`} action={data.experiences.length > 1 && <Button variant="danger" onClick={() => removeExperience(exp.id)} className="text-sm py-1 px-3">Remove</Button>}>
                            <div className="space-y-6 mb-8">
                                <div><label className="block text-sm font-semibold text-gray-700 mb-2 ml-1">Billing Account</label><input type="text" value={exp.billingAccount} onChange={e => updateExperience(exp.id, { billingAccount: e.target.value })} className="w-full px-4 py-3.5 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none shadow-sm" placeholder="e.g. 90012345" /></div>
                                <SearchableSelect label="Sub-District (Kelurahan) *" options={SUBDISTRICT_OPTIONS} value={exp.subDistrict} onChange={val => updateExperience(exp.id, { subDistrict: val })} placeholder="Select Kelurahan..." />
                                <div><label className="block text-sm font-semibold text-gray-700 mb-2 ml-1">Customer Name</label><input type="text" value={exp.name} onChange={e => updateExperience(exp.id, { name: e.target.value })} className="w-full px-4 py-3.5 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none shadow-sm" placeholder="Full Name" /></div>
                            </div>
                            <div className="bg-gray-50/50 rounded-2xl p-6 mb-6 border border-gray-100"><h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-5">Service Quality Ratings</h4>
                                <div className="space-y-5">{Object.entries(exp.ratings).map(([key, val]) => {
                                    // Mapping Label
                                    let label = key;
                                    if (key === 'overall') label = 'Overall Satisfaction';
                                    else if (key === 'support') label = 'After Sales';
                                    
                                    return (
                                        <div key={key} className="flex flex-col sm:flex-row sm:items-center justify-between gap-3"><span className="text-gray-700 font-medium capitalize text-sm w-1/3">{label}</span><div className="flex space-x-3">{[1, 2, 3, 4, 5].map(star => <button key={star} type="button" onClick={() => updateExperience(exp.id, { ratings: { ...exp.ratings, [key]: star } })} className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${val >= star ? 'bg-yellow-400 text-white scale-105' : 'bg-gray-200 text-gray-400'}`}><svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></button>)}</div></div>
                                    );
                                })}</div>
                            </div>
                            <div className="mb-8"><label className="block text-sm font-semibold text-gray-700 mb-2 ml-1">Analysis Summary</label><div className="bg-blue-50/50 border border-blue-100 p-5 rounded-xl text-gray-700 text-sm leading-relaxed min-h-[80px]" dangerouslySetInnerHTML={{ __html: exp.summary }} /></div>
                            <div><label className="block text-sm font-semibold text-gray-700 mb-3 ml-1">Visitation Evidence</label><div className="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">{exp.images.map(img => (
                                <div key={img.id} className="group relative aspect-[4/3] bg-gray-100 rounded-xl overflow-hidden shadow-sm border border-gray-200"><img src={img.src} className="w-full h-full object-cover" alt="Evidence" /><div className="absolute inset-0 bg-black/0 group-hover:bg-black/40 transition-all flex items-center justify-center"><button onClick={() => updateExperience(exp.id, { images: exp.images.filter(i => i.id !== img.id) })} className="opacity-0 group-hover:opacity-100 bg-white text-red-500 p-2 rounded-full shadow-lg scale-75 group-hover:scale-100 transition-transform"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></div>
                            ))}</div><button onClick={() => { setActiveExpId(exp.id); setShowSourceSelector(true); }} className="w-full py-4 border-2 border-dashed border-brand-300 bg-brand-50 hover:bg-brand-100 rounded-2xl flex flex-col items-center justify-center text-brand-600 transition-all"><div className="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center mb-2 text-brand-500"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" /></svg></div><span className="text-sm font-bold">Upload Evidence</span></button></div>
                        </Card>
                    ))}
                    <div className="text-center pt-4"><Button onClick={addExperience} variant="secondary" className="w-full sm:w-auto px-8 py-3.5" icon={<span className="text-lg font-bold">+</span>}>Add Another Customer</Button></div>
                    <CameraModal isOpen={cameraOpen} onClose={() => setCameraOpen(false)} onCapture={handleImageCapture} />
                    {showSourceSelector && (
                        <div className="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center sm:p-4" onClick={() => setShowSourceSelector(false)}>
                            <div className="bg-white w-full sm:max-w-sm rounded-t-2xl sm:rounded-2xl shadow-2xl overflow-hidden animate-slide-up pb-[calc(1rem+env(safe-area-inset-bottom))]" onClick={e => e.stopPropagation()}>
                                <div className="p-5 text-center border-b border-gray-100 bg-gray-50/50"><h3 className="font-bold text-gray-900 text-lg">Add Photo</h3><p className="text-sm text-gray-500">Select a source for your evidence</p></div>
                                <div className="p-4 space-y-3">
                                    <button onClick={() => { setShowSourceSelector(false); setCameraOpen(true); }} className="w-full flex items-center p-4 bg-white border border-gray-200 hover:bg-gray-50 rounded-xl transition-colors"><div className="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center mr-4 text-blue-600"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg></div><div className="text-left"><div className="font-bold text-gray-800 text-lg">Take Photo</div><div className="text-sm text-gray-500">Use camera with timestamp</div></div></button>
                                    <label className="w-full flex items-center p-4 bg-white border border-gray-200 hover:bg-gray-50 rounded-xl transition-colors cursor-pointer"><div className="w-12 h-12 bg-purple-50 rounded-full flex items-center justify-center mr-4 text-purple-600"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></div><div className="text-left"><div className="font-bold text-gray-800 text-lg">From Album</div><div className="text-sm text-gray-500">Choose existing photo</div></div><input type="file" accept="image/*" className="hidden" onChange={e => { setShowSourceSelector(false); handleFileUpload(e, activeExpId); }} /></label>
                                </div>
                                <div className="p-4 pt-0"><button onClick={() => setShowSourceSelector(false)} className="w-full py-3.5 bg-gray-100 text-gray-700 font-bold rounded-xl">Cancel</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const HiddenReportTemplate = ({ data }) => {
            const containerStyle = { position: 'absolute', top: '-10000px', left: '-10000px', width: '800px', zIndex: -1, backgroundColor: 'white', fontFamily: 'Helvetica, Arial, sans-serif', color: '#333' };
            return (
                <div style={containerStyle}><div id="report-preview-container" className="p-12 bg-white">
                    <div className="border-b-4 border-gray-800 pb-6 mb-10 flex justify-between items-start">
                        <div><h1 className="text-4xl font-bold text-gray-900 uppercase tracking-widest leading-tight">Visitation<br/>Report</h1><div className="mt-3 text-gray-500 font-bold uppercase tracking-wide text-sm flex items-center gap-2"><span className="bg-blue-700 text-white px-2 py-0.5 text-xs rounded-sm">W4</span><span>West Territory 4</span></div></div>
                        <div className="text-right bg-gray-50 p-4 rounded border border-gray-200 min-w-[240px]"><div className="text-sm text-gray-600 space-y-2"><div className="flex justify-between gap-4 border-b border-gray-200 pb-1"><span className="font-bold text-gray-400 uppercase text-xs">Date</span><span className="font-bold text-gray-900">{new Date(data.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}</span></div><div className="flex justify-between gap-4 border-b border-gray-200 pb-1"><span className="font-bold text-gray-400 uppercase text-xs">Visitor</span><span className="font-bold text-gray-900 text-right">{data.visitorName}</span></div><div className="flex justify-between gap-4"><span className="font-bold text-gray-400 uppercase text-xs">Branch</span><span className="font-bold text-gray-900 text-right">{data.branchName}</span></div></div></div>
                    </div>
                    {data.includeInternal && (
                        <div className="mb-12"><div className="flex items-center mb-4"><h2 className="text-lg font-bold text-white bg-gray-800 px-4 py-1.5 uppercase tracking-wider">1. Branch Audit</h2><div className="h-0.5 bg-gray-800 flex-grow ml-2"></div></div>
                            <table className="w-full border-collapse border border-gray-300 text-sm shadow-sm"><thead><tr className="bg-gray-100 text-left"><th className="border border-gray-300 p-3 w-1/3 font-bold text-gray-700 uppercase text-xs tracking-wide">Aspect</th><th className="border border-gray-300 p-3 w-28 text-center font-bold text-gray-700 uppercase text-xs tracking-wide">Status</th><th className="border border-gray-300 p-3 font-bold text-gray-700 uppercase text-xs tracking-wide">Notes</th></tr></thead><tbody>{data.aspects.map(a => (<tr key={a.id} className="even:bg-gray-50/50"><td className="border border-gray-300 p-3 font-semibold text-gray-800">{a.title}</td><td className="border border-gray-300 p-3 text-center align-middle">{a.status === AspectStatus.NEED_IMPROVEMENT ? <span className="inline-block text-red-700 font-bold text-[10px] border border-red-300 bg-red-50 px-2 py-1 rounded uppercase">Improve</span> : a.status === AspectStatus.NO_NEED ? <span className="inline-block text-green-700 font-bold text-[10px] border border-green-300 bg-green-50 px-2 py-1 rounded uppercase">Good</span> : <span className="text-gray-300">-</span>}</td><td className="border border-gray-300 p-3 text-gray-600 text-sm leading-relaxed">{a.status === AspectStatus.NEED_IMPROVEMENT ? a.description : <span className="text-gray-400 italic text-xs">No issues reported</span>}</td></tr>))}</tbody></table>
                        </div>
                    )}
                    <div><div className="flex items-center mb-6"><h2 className="text-lg font-bold text-white bg-gray-800 px-4 py-1.5 uppercase tracking-wider">{data.includeInternal ? '2. Customer Experience' : '1. Customer Experience'}</h2><div className="h-0.5 bg-gray-800 flex-grow ml-2"></div></div>
                        <div className="space-y-8">{data.experiences.map((exp, i) => (
                            <div key={exp.id} className="border border-gray-300 break-inside-avoid bg-white shadow-sm">
                                <div className="bg-gray-100 p-4 border-b border-gray-300 flex justify-between items-center"><div className="flex items-center gap-3"><span className="flex items-center justify-center w-6 h-6 bg-gray-800 text-white rounded text-xs font-bold">{i+1}</span><div><h3 className="font-bold text-gray-900 text-lg leading-none">{exp.name}</h3>{exp.subDistrict && <span className="text-[10px] text-gray-500 uppercase tracking-wide">{exp.subDistrict}</span>}</div></div><div className="font-mono text-xs text-gray-600 bg-white px-2 py-1 border border-gray-300 rounded">ID: <b>{exp.billingAccount}</b></div></div>
                                <div className="p-5"><div className="flex gap-8 mb-6"><div className="w-1/2 flex-shrink-0"><h4 className="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 border-b border-gray-200 pb-1">Performance Ratings</h4><table className="w-full text-sm"><tbody>{[ ['Internet Speed', exp.ratings.speed], ['Connection Stability', exp.ratings.stability], ['After Sales', exp.ratings.support], ['Price Value', exp.ratings.price], ['Overall Satisfaction', exp.ratings.overall] ].map(([label, score]) => (<tr key={label}><td className="py-1.5 text-gray-600 font-medium">{label}</td><td className="py-1.5 text-right font-bold text-yellow-500" style={{ letterSpacing: '2px', fontSize: '14px' }}>{'‚òÖ'.repeat(score)}{'‚òÜ'.repeat(5-score)}</td></tr>))}</tbody></table></div><div className="w-1/2"><h4 className="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 border-b border-gray-200 pb-1">Automated Summary</h4><div className="text-xs text-gray-700 leading-relaxed bg-blue-50/50 p-3 border border-blue-100 rounded text-justify" dangerouslySetInnerHTML={{__html: exp.summary.replace(/<[^>]*>?/gm, '') || '<span class="text-gray-400 italic">No summary available.</span>'}} /></div></div>
                                    {exp.images.length > 0 && (<div className="border-t border-gray-200 pt-4"><h4 className="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3">Documentation</h4><div className="grid grid-cols-2 gap-4 items-start">{exp.images.map((img, idx) => (<div key={idx} className="border border-gray-200 p-1.5 bg-white shadow-sm rounded"><img src={img.src} style={{ display: 'block', width: '100%', height: 'auto', objectFit: 'contain', borderRadius: '2px' }} alt={`Evidence ${idx+1}`} /><div className="mt-2 flex justify-between items-end px-1 pb-1 border-t border-gray-100 pt-1"><span className="text-[9px] text-gray-500 font-mono">{img.timestamp}</span>{img.location && <span className="text-[9px] text-blue-600 font-mono max-w-[60%] truncate">{img.location}</span>}</div></div>))}</div></div>)}
                                </div>
                            </div>
                        ))}</div>
                    </div>
                    <div className="mt-16 pt-6 border-t border-gray-300 text-center flex justify-between items-center"><div className="text-[10px] text-gray-400 uppercase tracking-widest">Confidential Document</div><div className="text-[10px] text-gray-400 uppercase tracking-widest">Generated by Leader On Site</div></div>
                </div></div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [currentTab, setCurrentTab] = useState('basic');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [data, setData] = useState({
                date: new Date().toISOString().split('T')[0], visitorName: '', branchName: '', includeInternal: false, aspects: INITIAL_ASPECTS,
                experiences: [{ id: generateUUID(), billingAccount: '', subDistrict: '', name: '', ratings: { speed: 0, stability: 0, support: 0, price: 0, overall: 0 }, summary: 'Please provide ratings...', images: [] }]
            });
            const updateData = (updates) => setData(p => ({ ...p, ...updates }));

            const tabs = [ { id: 'basic', label: 'Overview', icon: 'üìù' }, { id: 'internal', label: 'Sidak', icon: 'üè¢', hidden: !data.includeInternal }, { id: 'customer', label: 'Customers', icon: 'üë•' } ].filter(t => !t.hidden);
            const currentTabIndex = tabs.findIndex(t => t.id === currentTab);

            const canProceed = () => {
                if (currentTab === 'basic') return data.date && data.visitorName && data.branchName;
                if (currentTab === 'internal') return data.aspects.every(a => a.status !== AspectStatus.UNSELECTED);
                if (currentTab === 'customer') return data.experiences.every(e => e.name && e.billingAccount && e.subDistrict && e.images.length > 0);
                return true;
            };

            const handleNext = async () => {
                if (currentTabIndex < tabs.length - 1) { 
                    setCurrentTab(tabs[currentTabIndex + 1].id); 
                    window.scrollTo({ top: 0, behavior: 'smooth' }); 
                } else {
                    if(!confirm("Ready to generate report?")) return;
                    setIsSubmitting(true);
                    const success = await generateAndSendReport(data);
                    setIsSubmitting(false);
                    
                    if (success) {
                        // Reset form logic
                        setData({
                            date: new Date().toISOString().split('T')[0], 
                            visitorName: '', 
                            branchName: '', 
                            includeInternal: false, 
                            aspects: INITIAL_ASPECTS,
                            experiences: [{ id: generateUUID(), billingAccount: '', subDistrict: '', name: '', ratings: { speed: 0, stability: 0, support: 0, price: 0, overall: 0 }, summary: 'Please provide ratings...', images: [] }]
                        });
                        setCurrentTab('basic');
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        alert("Laporan udah diisi, makasih kakak!.");
                    }
                }
            };

            return (
                <div className="min-h-screen pb-[calc(1rem+env(safe-area-inset-bottom))]">
                    <header className="bg-white/90 backdrop-blur-xl border-b border-gray-200 sticky top-0 z-30 transition-all">
                        <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2"><div className="w-9 h-9 bg-gradient-to-br from-brand-500 to-brand-700 rounded-xl shadow-lg shadow-brand-500/20 flex items-center justify-center text-white font-bold">W4</div><div><h1 className="text-lg font-bold text-gray-900 tracking-tight leading-none">Leader<span className="text-brand-600">OnSite</span></h1><span className="text-xs text-gray-500 font-medium">West Territory 4</span></div></div>
                            <div className="hidden sm:block"><span className="px-3 py-1 bg-green-50 text-green-700 border border-green-100 rounded-full text-xs font-semibold">Online v1.2</span></div>
                        </div>
                    </header>

                    <div className="max-w-3xl mx-auto px-4 py-8"><nav aria-label="Progress"><ol role="list" className="flex items-center w-full">{tabs.map((tab, index) => {
                        const isActive = tab.id === currentTab; const isCompleted = index < currentTabIndex; const isLast = index === tabs.length - 1;
                        return (
                            <li key={tab.id} className={`relative ${!isLast ? 'flex-1' : ''}`}>
                                {!isLast && <div className="absolute top-5 left-0 w-full pl-10 -ml-2"><div className={`h-1 rounded-full transition-all duration-500 ${isCompleted ? 'bg-brand-500' : 'bg-gray-200'}`} /></div>}
                                <div className="group relative flex flex-col items-center cursor-pointer z-10" onClick={() => (isCompleted || isActive) && setCurrentTab(tab.id)}>
                                    <span className={`h-10 w-10 flex items-center justify-center rounded-full text-lg transition-all duration-300 shadow-sm ${isActive ? 'bg-brand-600 text-white ring-4 ring-brand-100 scale-110' : isCompleted ? 'bg-brand-600 text-white' : 'bg-white border-2 border-gray-200 text-gray-400'}`}>{isCompleted ? '‚úì' : tab.icon}</span>
                                    <span className={`mt-2 text-xs font-bold uppercase tracking-wider transition-colors ${isActive ? 'text-brand-700' : 'text-gray-400'}`}>{tab.label}</span>
                                </div>
                            </li>
                        );
                    })}</ol></nav></div>

                    <main className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pb-32">
                        {currentTab === 'basic' && <StepOneBasic data={data} updateData={updateData} />}
                        {currentTab === 'internal' && <StepTwoAspects data={data} updateData={updateData} />}
                        {currentTab === 'customer' && <StepThreeExperience data={data} updateData={updateData} />}
                    </main>

                    <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-gray-200 p-4 z-40 shadow-[0_-4px_20px_-5px_rgba(0,0,0,0.05)] pb-[calc(1rem+env(safe-area-inset-bottom))]">
                        <div className="max-w-4xl mx-auto flex justify-between items-center gap-4">
                            <Button variant="secondary" onClick={() => setCurrentTab(tabs[currentTabIndex - 1].id)} disabled={currentTabIndex === 0} className="flex-1 sm:flex-none sm:w-32">Back</Button>
                            <div className="text-sm text-gray-500 hidden sm:block font-medium">{canProceed() ? 'Ready to continue' : 'Complete required fields'}</div>
                            <Button variant="primary" onClick={handleNext} disabled={!canProceed()} isLoading={isSubmitting} className="flex-1 sm:flex-none sm:w-40 shadow-brand-500/30 shadow-lg">{currentTabIndex === tabs.length - 1 ? 'Generate Report' : 'Next Step'}</Button>
                        </div>
                    </div>
                    <HiddenReportTemplate data={data} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
